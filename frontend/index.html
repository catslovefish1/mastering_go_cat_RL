<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Try to defeat aggressive browser caching during dev -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Go Game Viewer — simple index.html</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151924; --border:#2a3142; --muted:#8a94a7;
      --text:#e6eaf2; --accent:#8bd3ff; --accent2:#90ee90;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background:radial-gradient(1200px 600px at 20% -10%, #1b2030 0%, #0f1115 60%);
    }
    .wrap{display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px; height:100%}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .side{display:flex; flex-direction:column; gap:12px; padding:14px}
    h1{font-size:16px; margin:4px 0 12px 0; color:var(--accent)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .row > *{flex:0 0 auto}
    .grow{flex:1}
    button, input[type="file"], select{
      background:#1c2232; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer
    }
    button:hover{background:#20283a}
    button:disabled{opacity:.5; cursor:not-allowed}
    input[type="range"]{width:100%}
    .meta{font-size:12px; color:var(--muted)}
    .pill{border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted)}
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .kpi .box{background:#111523; border:1px solid var(--border); border-radius:12px; padding:10px}
    .kpi .val{font-size:18px}
    .boardWrap{display:flex; align-items:center; justify-content:center; height:100%;}
    canvas{background:#dcb35c; border-radius:12px; border:2px solid #8f6b1f; max-width:100%; height:auto}
    .footer{padding:8px 14px; text-align:center; color:var(--muted)}
    .link{color:var(--accent2); text-decoration:none}
    details{border:1px dashed var(--border); border-radius:12px; padding:8px}
    textarea{width:100%; min-height:120px; background:#0f1320; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px}
    @media (max-width: 920px){ .wrap{grid-template-columns: 1fr; grid-auto-rows:min-content auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left panel: controls/info -->
    <section class="card side">
      <h1>Go Game Viewer</h1>
      <div class="row">
        <input id="file" type="file" accept="application/json" />
        <button id="btnDemo" title="Load a tiny built‑in demo JSON">Demo</button>
        <button id="btnSibling" title="Fetch ../game_histories/game_000.json (same repo level)">Load game_000.json</button>
        <button id="btnPaste">Paste JSON</button>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="meta">Game ID</div>
          <div id="gameId" class="val">—</div>
        </div>
        <div class="box">
          <div class="meta">Board</div>
          <div id="boardSize" class="val">—</div>
        </div>
        <div class="box">
          <div class="meta">Total moves</div>
          <div id="totalMoves" class="val">—</div>
        </div>
        <div class="box">
          <div class="meta">Final hash</div>
          <div id="finalHash" class="val">—</div>
        </div>
      </div>

      <div class="row">
        <button id="first">⏮︎</button>
        <button id="prev">◀︎</button>
        <button id="play">▶︎</button>
        <button id="next">▶︎</button>
        <button id="last">⏭︎</button>
        <select id="speed" title="Autoplay speed">
          <option value="1200">0.8×</option>
          <option value="800" selected>1×</option>
          <option value="500">1.6×</option>
          <option value="300">2.6×</option>
        </select>
        <span class="pill" id="moveLabel">Move —/—</span>
      </div>

      <input id="slider" type="range" min="0" max="0" step="1" value="0" />

      <div class="row">
        <div class="pill" id="changeType">—</div>
        <div class="pill" id="preHash">pre: —</div>
        <div class="pill" id="postHash">post: —</div>
      </div>

      <details>
        <summary>Paste JSON here</summary>
        <textarea id="pasteArea" placeholder='Paste the whole game object JSON…'></textarea>
        <div class="row" style="margin-top:6px">
          <button id="pasteLoad">Load from textarea</button>
          <button id="pasteClear">Clear</button>
        </div>
      </details>

      <p class="meta">
        Expected schema:
        <code>{ game_id, board_size, total_moves, moves:[ { move_number, board_state:[…], changes:[…], pre_hash, post_hash } … ] }</code>
      </p>

      <div class="footer">Keyboard: <span class="pill">←/→</span> step · <span class="pill">Space</span> play/pause · <span class="pill">R</span> hard reload (cache bust)</div>
    </section>

    <!-- Right: board -->
    <section class="card boardWrap">
      <canvas id="board" width="780" height="780"></canvas>
    </section>
  </div>

  <script>
  // ===== Utilities =====
  const $ = sel => document.querySelector(sel);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  // ===== State =====
  const state = {
    game: null,
    idx: 0,         // 0-based index into moves array
    timer: null,
  };

  // ===== Star point helpers =====
  function starPoints(n){
    // Standard hoshi: 19→ [4,10,16], 13→ [4,7,10], 9→ [3,5,7]
    const map = { 19:[4,10,16], 13:[4,7,10], 9:[3,5,7] };
    if(!map[n]) return [];
    const xs = map[n];
    const pts = [];
    for(const r of xs){
      for(const c of xs){ pts.push([r-1, c-1]); }
    }
    // center already included above for odd boards
    return pts;
  }

  // ===== Rendering =====
  function render(){
    const canvas = $('#board');
    const ctx = canvas.getContext('2d');
    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const N = state.game?.board_size || 19;
    const M = N; // square
    const pad = 40; // outer margin
    const w = canvas.width - 2*pad, h = canvas.height - 2*pad;
    const cellX = w / (M-1), cellY = h / (N-1);

    // Board wood already set via CSS background; draw grid
    ctx.translate(pad, pad);
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#333';

    for(let r=0;r<N;r++){
      ctx.beginPath();
      ctx.moveTo(0, r*cellY);
      ctx.lineTo(w, r*cellY);
      ctx.stroke();
    }
    for(let c=0;c<M;c++){
      ctx.beginPath();
      ctx.moveTo(c*cellX, 0);
      ctx.lineTo(c*cellX, h);
      ctx.stroke();
    }

    // star points
    const stars = starPoints(N);
    ctx.fillStyle = '#222';
    for(const [r,c] of stars){
      ctx.beginPath();
      ctx.arc(c*cellX, r*cellY, Math.max(2, Math.min(cellX,cellY)*0.09), 0, Math.PI*2);
      ctx.fill();
    }

    // stones
    if(state.game && state.game.moves?.length){
      const move = state.game.moves[state.idx];
      const flat = move.board_state; // length N*N
      const rad = Math.min(cellX, cellY) * 0.45;
      for(let r=0;r<N;r++){
        for(let c=0;c<M;c++){
          const v = flat[r*M + c]; // -1 empty, 0 black, 1 white
          if(v === -1) continue;
          ctx.beginPath();
          ctx.arc(c*cellX, r*cellY, rad, 0, Math.PI*2);
          if(v === 0){
            ctx.fillStyle = '#111';
            ctx.shadowColor = 'rgba(0,0,0,.35)'; ctx.shadowBlur = 6; ctx.shadowOffsetY = 2;
            ctx.fill();
            ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
          } else {
            const g = ctx.createRadialGradient(c*cellX - rad*0.3, r*cellY - rad*0.3, rad*0.2, c*cellX, r*cellY, rad);
            g.addColorStop(0, '#fff'); g.addColorStop(1, '#cfcfcf');
            ctx.fillStyle = g;
            ctx.strokeStyle = '#444'; ctx.lineWidth = 1;
            ctx.fill(); ctx.stroke();
          }
        }
      }
    }

    ctx.restore();
    updateInfo();
  }

  function updateInfo(){
    const g = state.game;
    if(!g){
      $('#gameId').textContent = '—';
      $('#boardSize').textContent = '—';
      $('#totalMoves').textContent = '—';
      $('#finalHash').textContent = '—';
      $('#moveLabel').textContent = 'Move —/—';
      $('#changeType').textContent = '—';
      $('#preHash').textContent = 'pre: —';
      $('#postHash').textContent = 'post: —';
      $('#slider').disabled = true;
      ['first','prev','next','last','play'].forEach(id=>$('#'+id).disabled=true);
      return;
    }
    $('#gameId').textContent = g.game_id ?? '—';
    $('#boardSize').textContent = g.board_size ?? '—';
    $('#totalMoves').textContent = g.total_moves ?? (g.moves?.length ?? '—');
    $('#finalHash').textContent = g.final_hash ?? '—';

    const L = g.moves?.length ?? 0;
    $('#slider').disabled = L===0;
    ['first','prev','next','last','play'].forEach(id=>$('#'+id).disabled=L===0);

    if(L){
      const m = g.moves[state.idx];
      $('#moveLabel').textContent = `Move ${m.move_number ?? (state.idx+1)} / ${L}`;
      const change = Array.isArray(m.changes) && m.changes[0] ? m.changes[0] : null;
      $('#changeType').textContent = change ? (change.type || JSON.stringify(change)) : '—';
      $('#preHash').textContent = 'pre: ' + (m.pre_hash ?? '—');
      $('#postHash').textContent = 'post: ' + (m.post_hash ?? '—');

      const slider = $('#slider');
      slider.max = String(L-1);
      slider.value = String(state.idx);
    }
  }

  // ===== Loading =====
  function loadGame(obj){
    if(!obj || !obj.board_size || !Array.isArray(obj.moves)){
      alert('Not a valid game JSON. Expect { board_size, moves:[…] }');
      return;
    }
    state.game = obj;
    state.idx = 0;
    stop();
    render();
  }

  async function loadSiblingJson(){
    // If you serve from project root and open /frontend/index.html,
    // this relative path resolves to /game_histories/game_000.json
    // We add a cache-busting query and disable fetch cache.
    const url = '../game_histories/game_000.json?v=' + Date.now();
    try{
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const data = await res.json();
      loadGame(data);
    }catch(err){
      alert('Failed to fetch '+url+'\nTip: run the server from your project root so /game_histories is reachable.\nError: '+err);
    }
  }

  $('#file').addEventListener('change', (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{ loadGame(JSON.parse(String(e.target.result))); }
      catch(err){ alert('Failed to parse JSON: '+err); }
    };
    reader.readAsText(f);
  });

  $('#btnPaste').addEventListener('click', ()=>{
    document.querySelector('details').open = true;
    $('#pasteArea').focus();
  });
  $('#btnSibling').addEventListener('click', loadSiblingJson);
  $('#pasteLoad').addEventListener('click', ()=>{
    try{ loadGame(JSON.parse($('#pasteArea').value)); }
    catch(err){ alert('Failed to parse JSON: '+err); }
  });
  $('#pasteLoad').addEventListener('click', ()=>{
    try{ loadGame(JSON.parse($('#pasteArea').value)); }
    catch(err){ alert('Failed to parse JSON: '+err); }
  });
  $('#pasteClear').addEventListener('click', ()=> $('#pasteArea').value='');

  // Tiny demo with a 9x9 board and a couple moves
  $('#btnDemo').addEventListener('click', ()=>{
    const demo = {
      game_id: 42,
      board_size: 9,
      total_moves: 3,
      final_hash: 123,
      moves: [
        { move_number: 1, board_state: Array(81).fill(-1).map((v,i)=> i===40?0:-1), changes:[{type:'place', color:'black', at:[5,5]}], pre_hash:0, post_hash:111 },
        { move_number: 2, board_state: Array(81).fill(-1).map((v,i)=> i===40?0:(i===41?1:-1)), changes:[{type:'place', color:'white', at:[5,6]}], pre_hash:111, post_hash:222 },
        { move_number: 3, board_state: Array(81).fill(-1).map((v,i)=> i===40?0:(i===41?1:(i===31?0:-1))), changes:[{type:'place', color:'black', at:[4,6]}], pre_hash:222, post_hash:333 },
      ]
    };
    loadGame(demo);
  });

  // ===== Controls =====
  function stop(){ if(state.timer){ clearInterval(state.timer); state.timer=null; $('#play').textContent='▶︎'; } }
  function play(){ stop(); state.timer = setInterval(()=> step(+1), Number($('#speed').value)); $('#play').textContent='⏸'; }
  function togglePlay(){ state.timer? stop(): play(); }

  function step(dir){
    if(!state.game) return;
    const L = state.game.moves.length;
    state.idx = clamp(state.idx + dir, 0, L-1);
    render();
  }

  $('#first').onclick = ()=>{ state.idx=0; render(); };
  $('#last').onclick  = ()=>{ if(state.game){ state.idx=state.game.moves.length-1; render(); } };
  $('#prev').onclick  = ()=> step(-1);
  $('#next').onclick  = ()=> step(+1);
  $('#play').onclick  = ()=> togglePlay();
  $('#slider').addEventListener('input', (e)=>{ state.idx = Number(e.target.value); render(); });
  document.addEventListener('keydown', (e)=>{
    if(e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
    if(e.key === 'ArrowLeft') step(-1);
    else if(e.key === 'ArrowRight') step(+1);
    else if(e.code === 'Space'){ e.preventDefault(); togglePlay(); }
    else if(e.key.toLowerCase() === 'r'){ location.href = location.pathname + '?v=' + Date.now(); }
  });

  // Initial blank render
  render();
  </script>
</body>
</html>
